# MyKeyboardTyping - システム全体設計ドキュメント

## 1. プロジェクト概要

### 1.1 目的
自作キーボード（特にカラムスタッガード分割キーボード）のユーザーが、キーボード固有のキー配列に合わせてタイピング練習を行うためのWebベースツール。

### 1.2 対象キーボード
- **初期対応**: Ergo68（68キー、左右34+34キーの分割キーボード）
- **将来対応**: 他のRemap対応キーボード
- **キーマップ取得方法**: WebHID APIを利用してキーボードから動的に取得

### 1.3 主要機能
1. **WebHIDを介したキーマップ動的読み込み**
   - 接続されたRemap対応キーボードのリスト表示
   - キーボード選択時に全レイヤー（0～3）のキーマップを取得

2. **タイピング練習機能**
   - ビルトイン練習素材（日本語テキスト）の提供
   - リアルタイムキー入力検出と表示
   - 入力状況の可視化（入力済み部分の色分け）

3. **キーボード可視化**
   - SVG/HTMLによるキーボードレイアウトの動的描画
   - 入力されたキーのハイライト表示
   - 全レイヤー同時表示および個別表示切り替え機能

4. **統計情報の表示**
   - WPM（Words Per Minute）
   - 正確率（%）
   - ミス数
   - 経過時間

5. **誤入力ハンドリング**
   - 誤入力時のビジュアルフィードバック
   - 正しい入力まで進行しない（スキップ不可）

---

## 2. 技術スタック

### フロントエンド
- **フレームワーク**: Nuxt 4 (Vue 3)
- **スタイリング**: Tailwind CSS
- **言語**: TypeScript
- **主要ライブラリ**:
  - WebHID API（キーボード通信）
  - SVG（キーボード描画）

### 対応環境
- **ブラウザ**: Chrome
- **OS**: Windows

---

## 3. ユースケースフロー

### 3.1 初期化フロー
```
1. ユーザーがアプリケーションにアクセス
2. WebHID API経由でシステムに接続されているキーボード一覧を取得
3. キーボードリストを表示
4. ユーザーが対象キーボード（Ergo68）を選択
5. 選択されたキーボードからレイヤー0～3のキーマップを取得
6. タイピング練習画面を初期化
```

### 3.2 タイピング練習フロー
```
1. ビルトイン練習素材が表示される
2. ユーザーがキーボードでテキストを入力
3. 各キー入力時：
   a. キーボード画像上で該当キーをハイライト
   b. 入力テキスト上で入力位置を示す
   c. 正誤判定を実行
4. 正入力時：
   a. キーをハイライト（成功表示）
   b. 入力位置を進める
5. 誤入力時：
   a. エラーエフェクト表示（キーボードと入力テキスト）
   b. 入力位置は進まない（再入力待ち）
6. テキスト全入力完了時：
   a. 結果画面を表示
   b. WPM、正確率、ミス数、経過時間を表示
```

### 3.3 レイヤー表示管理フロー
```
1. 初期状態ではレイヤー0のみ表示
2. ユーザーは任意のレイヤーの表示/非表示を切り替え可能
3. 複数レイヤーの同時表示が可能
4. 各レイヤーで入力されたキーは全レイヤーで同時にハイライト
5. レイヤー切り替えキー（MO(n)）の自動検知は将来機能として検討
```

**注**: MO(n)キーによる自動レイヤー切り替えは、物理キー入力からの検知が困難なため、現バージョンでは実装していません。

---

## 4. 詳細仕様

### 4.1 キーボード管理
**詳細は `02_キーボード管理機能.md` を参照**

### 4.2 入力処理・判定ロジック
**詳細は `03_入力処理と判定ロジック.md` を参照**

### 4.3 UIコンポーネント設計
**詳細は `04_UIコンポーネント設計.md` を参照**

### 4.4 データ構造定義
**詳細は `05_データ構造定義.md` を参照**

### 4.5 練習素材管理
**詳細は `06_練習素材管理.md` を参照**

---

## 5. 非機能要件

### 5.1 パフォーマンス
- キーボード入力レスポンス: 100ms以下
- キーマップ描画: 60fps維持
- キーボード初期化: 2秒以内

### 5.2 アクセシビリティ
- キーボード操作のみで完結（マウス不要）
- ハイコントラスト対応を検討

### 5.3 互換性
- Remap対応の任意のキーボードに対応可能な設計
- キーコードは標準的なHID キーコードに準拠

---

## 6. MVP スコープ

### 6.1 含める機能
- [x] WebHID API経由のキーボード検出・リスト化
- [x] Ergo68のキーマップ取得と表示
- [x] 全4レイヤー対応（表示/非表示の手動切り替え）
- [x] 全レイヤー同時キーハイライト表示
- [ ] 日本語（ローマ字入力・変換不要）のタイピング練習
- [ ] リアルタイムキーボードハイライト表示（練習中）
- [ ] 誤入力検出とエラーフィードバック
- [ ] WPM、正確率、ミス数、経過時間の計算・表示
- [ ] ビルトイン練習素材（1セット）

### 6.2 今後の拡張（スコープ外）
- [ ] MO(n)キーによる自動レイヤー切り替え検知
- [ ] ユーザーテキスト読み込み機能
- [ ] 複数キーボード対応
- [ ] 難易度レベル設定
- [ ] 進捗保存・統計記録

---

## 7. エラーハンドリング戦略

### 7.1 キーボード関連
| エラーケース | 対応 |
|-------------|------|
| キーボード未検出 | リスト空表示 + メッセージ表示 |
| キーボード接続解除 | エラーメッセージ表示 + リトライオプション |
| キーマップ取得失敗 | エラーメッセージ + リトライボタン |

### 7.2 入力関連
| エラーケース | 対応 |
|-------------|------|
| 誤入力 | ビジュアルエラーフィードバック（赤色ハイライト等）|
| 予期しないキー | エラーエフェクト表示 + ビープ音（オプション） |

---

## 8. 画面フロー図

```
┌─────────────────┐
│  キーボード選択  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│  タイピング練習画面         │
│  ┌─────────────────────────┐│
│  │  練習テキスト表示        ││
│  │  ↓入力状況ビジュアル     ││
│  └─────────────────────────┘│
│  ┌─────────────────────────┐│
│  │  キーボード表示（SVG）   ││
│  │  - 全レイヤー表示対応    ││
│  │  - キー入力ハイライト    ││
│  └─────────────────────────┘│
│  ┌─────────────────────────┐│
│  │  統計情報（リアルタイム） ││
│  │  - WPM                  ││
│  │  - 正確率               ││
│  │  - ミス数               ││
│  │  - 経過時間             ││
│  └─────────────────────────┘│
└────────┬────────────────────┘
         │ (テキスト入力完了)
         ▼
┌─────────────────┐
│   結果画面      │
└─────────────────┘
```

---

## 9. 開発ロードマップ

### フェーズ1: 基盤実装 ✅ 完了
1. ✅ WebHID API統合
2. ✅ キーボード検出・リスト機能
3. ✅ キーマップ取得処理
4. ✅ SVGキーボード描画エンジン

### フェーズ2: 入力処理 ✅ 部分完了
1. ✅ キー入力イベント検出
2. ✅ キーマップ参照とキーコード変換
3. ✅ 全レイヤーでのキー位置検索とハイライト
4. ⏳ 誤入力判定エンジン

### フェーズ3: UI実装 ✅ 部分完了
1. ✅ キーボード選択画面
2. ⏳ タイピング練習画面
3. ⏳ 結果表示画面
4. ✅ エラーハンドリングUI

### フェーズ4: 統計・練習素材 ⏳ 未完了
1. WPM等の計算ロジック
2. ビルトイン練習素材の定義
3. 練習素材ローテーション機能

### フェーズ5: 最適化・テスト ⏳ 未完了
1. パフォーマンス最適化
2. ブラウザ互換性テスト
3. ユーザビリティテスト

### 将来の拡張機能
- MO(n)キーによる自動レイヤー切り替え検知

---

## 10. ドキュメント一覧

| ドキュメント | 説明 |
|-----------|------|
| `01_システム全体設計.md` | このファイル。全体設計概要 |
| `02_キーボード管理機能.md` | WebHID、キーマップ取得、レイヤー管理 |
| `03_入力処理と判定ロジック.md` | 入力検出、キーコード変換、誤入力判定 |
| `04_UIコンポーネント設計.md` | React/Vue コンポーネント設計、画面構成 |
| `05_データ構造定義.md` | TypeScript インターフェース、データモデル |
| `06_練習素材管理.md` | 練習素材フォーマット、ひらがな・カタカナ・漢字マッピング |
