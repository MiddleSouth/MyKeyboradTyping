# MyKeyboardTyping - システム全体設計ドキュメント

## 1. プロジェクト概要

### 1.1 目的
自作キーボード（特にカラムスタッガード分割キーボード）のユーザーが、キーボード固有のキー配列に合わせてタイピング練習を行うためのWebベースツール。

### 1.2 対象キーボード
- **初期対応**: Ergo68（68キー、左右34+34キーの分割キーボード）
- **将来対応**: 他のRemap対応キーボード
- **キーマップ取得方法**: WebHID APIを利用してキーボードから動的に取得

### 1.3 主要機能
1. **WebHIDを介したキーマップ動的読み込み**
    - 接続されたRemap対応キーボードのリスト表示
    - キーボード選択時に全レイヤー（0～3）のキーマップを取得

2. **タイピング練習機能**
    - ビルトイン練習素材（日本語テキスト）の提供
    - リアルタイムキー入力検出と表示
    - 入力状況の可視化（入力済み部分の色分け）

3. **キーボード可視化**
    - SVG/HTMLによるキーボードレイアウトの動的描画
    - 入力されたキーのハイライト表示
    - 全レイヤー同時表示および個別表示切り替え機能

4. **統計情報の表示**
    - 正確率（%）
    - 正答数・誤答数
    - WPM（Words Per Minute）※将来実装検討

5. **誤入力ハンドリング**
    - 誤入力時のビジュアルフィードバック
    - 正しい入力まで進行しない（スキップ不可）

---

## 2. 技術スタック

### フロントエンド
- **フレームワーク**: Nuxt 4 (Vue 3)
- **スタイリング**: Tailwind CSS
- **言語**: TypeScript
- **主要ライブラリ**:
    - WebHID API（キーボード通信）
    - SVG（キーボード描画）

### 対応環境
- **ブラウザ**: Chrome
- **OS**: Windows

---

## 3. ユースケースフロー

### 3.1 初期化フロー
```
1. ユーザーがアプリケーションにアクセス
2. WebHID API経由でシステムに接続されているキーボード一覧を取得
3. キーボードリストを表示
4. ユーザーが対象キーボード（Ergo68）を選択
5. 選択されたキーボードからレイヤー0～3のキーマップを取得
6. タイピング練習画面を初期化
```

### 3.2 タイピング練習フロー
```
1. 練習素材選択画面が表示される
2. ユーザーが練習素材を選択
3. 練習画面に遷移し、選択した素材のテキストが表示される
4. ユーザーがキーボードでテキストを入力
5. 各キー入力時：
    a. キーボード画像上で該当キーをハイライト
    b. 入力テキスト上で入力位置を示す
    c. 正誤判定を実行
6. 正入力時：
    a. キーをハイライト（成功表示）
    b. 入力位置を進める
7. 誤入力時：
    a. エラーエフェクト表示（入力テキスト）
    b. 入力位置は進まない（再入力待ち）
8. 1単語の入力完了時：
    a. 次の単語に自動的に進む（複数単語の場合）
9. 全単語の入力完了時：
    a. 完了画面を表示
    b. 正確率、正答数、誤答数を表示
    c. 再挑戦または次の練習を選択可能
```

### 3.3 レイヤー表示管理フロー
```
1. 初期状態ではレイヤー0のみ表示
2. ユーザーは任意のレイヤーの表示/非表示を切り替え可能
3. 複数レイヤーの同時表示が可能
4. 各レイヤーで入力されたキーは全レイヤーで同時にハイライト
5. レイヤー切り替えキー（MO(n)）の自動検知は将来機能として検討
```

**注**: MO(n)キーによる自動レイヤー切り替えは、物理キー入力からの検知が困難なため、現バージョンでは実装していません。

---

## 4. 詳細仕様

### 4.1 キーボード管理
**詳細は `02_キーボード管理機能.md` を参照**

### 4.2 入力処理・判定ロジック
**詳細は `03_入力処理と判定ロジック.md` を参照**

### 4.3 UIコンポーネント設計
**詳細は `04_UIコンポーネント設計.md` を参照**

### 4.4 データ構造定義
**詳細は `05_データ構造定義.md` を参照**

### 4.5 練習素材管理
**詳細は `06_練習素材管理.md` を参照**

---

## 5. 非機能要件

### 5.1 パフォーマンス
- キーボード入力レスポンス: 100ms以下
- キーマップ描画: 60fps維持
- キーボード初期化: 2秒以内

### 5.2 アクセシビリティ
- キーボード操作のみで完結（マウス不要）
- ハイコントラスト対応を検討

### 5.3 互換性
- Remap対応の任意のキーボードに対応可能な設計
- キーコードは標準的なHID キーコードに準拠
（実装済み）
- [x] WebHID API経由のキーボード検出・リスト化
- [x] Ergo68のキーマップ取得と表示
- [x] 全4レイヤー対応（表示/非表示の手動切り替え）
- [x] 全レイヤー同時キーハイライト表示
- [x] 日本語（ローマ字入力）のタイピング練習
    - [x] ひらがな表示・ローマ字入力
    - [x] 複数入力パターン対応（「し」→ si/shi など）
    - [x] 拗音対応（きゃ、きゅ、きょ など）
    - [x] 促音対応（っ → 次の子音重ね、または ltu/xtu）
    - [x] 動的パターン切り替え
- [x] 英語（アルファベット）のタイピング練習
- [x] C#プログラミング向け練習素材
- [x] リアルタイムキーボードハイライト表示
- [x] 誤入力検出とエラーフィードバック
- [x] 正確率、正答数、誤答数の計算・表示
- [x] ビルトイン練習素材
    - [x] 日本語基礎（ひらがな、拗音・促音）
    - [x] 日本語日常単語
    - [x] C#基本記号・キーワード・コード例
- [x] 複数単語による練習セット（自動進行）
- [x] キーボードショートカット（BackSpace: 再挑戦、Enter: 次へ）

### 6.2 今後の拡張
- [ ] Ergo68以外のキーボード対応
    - [ ] KeyChron Q11 (所持キーボードの中でHID対応のもの)
    - [ ] 他キーボード対応を追加できる機能の整備（ハードコーディング or JSON読み込み）
- [ ] 自前の練習素材読み込み機能
- [ ] WPM（Words Per Minute）計算・表示
- [ ] 経過時間の表示
- [ ] MO(n)キーによる自動レイヤー切り替え検知

---

## 7. エラーハンドリング戦略

### 7.1 キーボード関連
| エラーケース | 対応 |
|-------------|------|
| キーボード未検出 | リスト空表示 + メッセージ表示 |
| キーボード接続解除 | エラーメッセージ表示 + リトライオプション |
| キーマップ取得失敗 | エラーメッセージ + リトライボタン |

### 7.2 入力関連
| エラーケース | 対応 |
|-------------|------|
| 誤入力 | ビジュアルエラーフィードバック（赤色ハイライト等）|
| 予期しないキー | エラーエフェクト表示 + ビープ音（オプション） |

---

## 8. 画面フロー図

```
┌─────────────────┐
│  キーボード選択  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│  タイピング練習画面         │
│  ┌─────────────────────────┐│
│  │  練習テキスト表示        ││
│  │  ↓入力状況ビジュアル     ││
│  └─────────────────────────┘│
│  ┌─────────────────────────┐│
│  │  キーボード表示（SVG）   ││
│  │  - 全レイヤー表示対応    ││
│  │  - キー入力ハイライト    ││
│  └─────────────────────────┘│
│  ┌─────────────────────────┐│
│  │  統計情報（リアルタイム） ││
│  │  - WPM                  ││
│  │  - 正確率               ││
│  │  - ミス数               ││
│  │  - 経過時間             ││
│  └─────────────────────────┘│
└────────┬────────────────────┘
         │ (テキスト入力完了)
         ▼
┌─────────────────┐
│   結果画面      │完了
1. ✅ キー入力イベント検出
2. ✅ キーマップ参照とキーコード変換
3. ✅ 全レイヤーでのキー位置検索とハイライト
4. ✅ 誤入力判定エンジン
5. ✅ 日本語入力判定（ローマ字→ひらがな変換）
6. ✅ 複数入力パターン対応・動的切り替え

### フェーズ3: UI実装 ✅ 完了
1. ✅ キーボード選択画面
2. ✅ タイピング練習画面
3. ✅ 完了画面（統計表示）
4. ✅ エラーハンドリングUI

### フェーズ4: 統計・練習素材 ✅ 完了
1. ✅ 正確率・正答数・誤答数の計算ロジック
2. ✅ ビルトイン練習素材の定義
   - ✅ 日本語基礎練習
   - ✅ C#プログラミング練習
3. ✅ 複数単語による練習セット
4. ✅ 練習素材選択機能

### フェーズ5: 最適化・テスト ⏳ 進行中
1. ✅ パフォーマンス最適化
2. ⏳ ブラウザ互換性テスト
3. ⏳ ユーザビリティテスト

### 将来の拡張機能
- WPM計算・表示
- 経過時間の計測
- MO(n)キーによる自動レイヤー切り替え検知
- 進捗保存・統計記録
4. ✅ エラーハンドリングUI

### フェーズ4: 統計・練習素材 ⏳ 未完了
1. WPM等の計算ロジック
2. ビルトイン練習素材の定義
3. 練習素材ローテーション機能

### フェーズ5: 最適化・テスト ⏳ 未完了
1. パフォーマンス最適化
2. ブラウザ互換性テスト
3. ユーザビリティテスト

### 将来の拡張機能
- MO(n)キーによる自動レイヤー切り替え検知

---

## 10. ドキュメント一覧

| ドキュメント | 説明 |
|-----------|------|
| `01_システム全体設計.md` | このファイル。全体設計概要 |
| `02_キーボード管理機能.md` | WebHID、キーマップ取得、レイヤー管理 |
| `03_入力処理と判定ロジック.md` | 入力検出、キーコード変換、誤入力判定 |
| `04_UIコンポーネント設計.md` | React/Vue コンポーネント設計、画面構成 |
| `05_データ構造定義.md` | TypeScript インターフェース、データモデル |
| `06_練習素材管理.md` | 練習素材フォーマット、ひらがな・カタカナ・漢字マッピング |
