# MyKeyboardTyping - 入力処理と判定ロジック仕様書

## 1. 概要

このドキュメントでは、キーボード入力の検出、タイピング判定、誤入力検出などの入力処理全般について定義します。

---

## 2. キー入力イベント処理

### 2.1 入力ソース

**実装方針**: ブラウザ標準の`KeyboardEvent`を使用し、WebHID APIで取得したキーマップと照合してキーボード上の物理的な位置を特定します。

**理由**: 
- WebHID APIからの直接入力は実装が複雑で、ブラウザの標準イベントで十分な機能を実現できる
- キーコード変換はキーマップデータを参照することで対応可能

### 2.2 キー入力の流れ

1. ブラウザの`keydown`イベントをリッスン
2. イベントからキーコード情報を取得
3. WebHID APIで取得したキーマップと照合
4. 全レイヤーから該当キーの位置を検索
5. 該当キーをハイライト表示
6. タイピング判定処理へ渡す

---

## 3. タイピング判定

### 3.1 英語入力の判定

英語（アルファベット、数字、記号）の入力は、期待される文字と入力文字を直接比較します。

**対応文字**:
- 英数字: `a-z`, `A-Z`, `0-9`
- 記号: `-`, `,`, `.`, `/`, `@`, `;`, `:`, `[`, `]`, `'`, `"`
- 特殊キー: スペース（`␣`表示）、Enter（`↵`表示）

### 3.2 日本語入力の判定

日本語入力はローマ字入力方式を採用します。画面上にはひらがなを表示し、ユーザーはローマ字で入力します。

**設計上の重要な仕様**:
**設計上の重要な仕様**:

1. **複数入力パターン対応**
   - 同じひらがなに対して複数のローマ字入力パターンを許容
   - 例: 「し」→ `si` または `shi`
   - 例: 「ち」→ `ti` または `chi`
   - 例: 「つ」→ `tu` または `tsu`
   - 例: 「ふ」→ `hu` または `fu`

2. **動的パターン切り替え**
   - ユーザーの入力に応じてパターンを自動切り替え
   - 例: 「し」の初期表示は`si`、ユーザーが`sh`と入力すると`shi`に切り替わる
   - 理由: ユーザーの入力習慣に柔軟に対応し、どちらの入力方法でも同じ体験を提供

3. **拗音（小さい「ゃ」「ゅ」「ょ」）対応**
   - 「きゃ」「きゅ」「きょ」などは1つの単位として扱う
   - ローマ字パターン: `kya`, `kyu`, `kyo` など
   - 画面表示もひらがなとローマ字の単位を一致させる

4. **促音（小さい「っ」）の特殊処理**
   - **方式1（推奨）**: 次の文字の子音を重ねる
     - 例: 「きって」→ `kitte` （`ki` + `t` + `te`）
     - 例: 「がっこう」→ `gakkou` （`ga` + `k` + `ko` + `u`）
   - **方式2（単独時）**: 直接入力
     - 例: 「っ」単独 → `ltu`, `xtu`, または `ltsu`
   - 理由: 日本語タイピングの一般的な入力方法に準拠

5. **進捗管理の一元化**
   - ひらがな表示は「ラベル」として扱う（ハイライトなし）
   - ローマ字部分のみを進捗管理・ハイライト表示
   - 理由: ひらがなとローマ字の文字数が一致しない（拗音など）ため、ローマ字ベースで管理することで実装を簡潔化

### 3.3 入力判定の流れ

1. ユーザーがキーを入力
2. 現在位置のひらがなに対応するローマ字パターンを取得
3. 部分一致判定（入力途中の状態）
4. 完全一致時、次の文字に進む
5. 不一致時、誤入力として処理

---

## 4. 誤入力検出とフィードバック

### 4.1 誤入力の定義

- 期待されるローマ字パターンに一致しない文字の入力
- 対応するパターンの開始文字列にならない入力

### 4.2 フィードバック

**視覚的フィードバック**:
- 誤入力時、入力テキスト部分に赤色ハイライト
- 正入力時、緑色でハイライト

**動作**:
- 誤入力では進行しない（正しい入力まで待機）
- 入力回数は統計にカウント（正確率計算に影響）

---

## 5. 統計情報の計算

### 5.1 計算項目

- **正答数**: 正しく入力された文字数
- **誤答数**: 誤って入力された回数（同じ位置で複数回ミスした場合も全てカウント）
- **正確率**: `正答数 / (正答数 + 誤答数) × 100`

### 5.2 将来実装検討

- **WPM（Words Per Minute）**: 1分あたりの入力単語数
  - 計算式: `(入力文字数 / 5) / (経過時間（秒） / 60)`
  - 理由: 英語圏の標準的な単語長を5文字と仮定
- **経過時間**: タイピング開始から完了までの時間

---

## 6. 設計上の留意点

### 6.1 可読性と保守性

- 判定ロジックは責任ごとに関数を分割
  - 特殊文字判定
  - 促音判定
  - 通常ひらがな判定
- 各判定ロジックは独立してテスト可能な構造

### 6.2 拡張性

- 新しい入力パターンの追加が容易
- カタカナ、漢字への対応も設計上可能（将来実装）

---

## 7. エラーハンドリング

| エラーケース | 対応 |
|-------------|------|
| 誤入力 | 赤色ハイライト表示、入力位置は進まない |
| 予期しないキー | 誤入力として扱う |
| 完了後の入力 | 無視（警告ログ） |

---

## 8. レイヤー管理と入力処理（将来実装）

MO(n) キー押下の自動検知は、以下の理由により現バージョンでは未実装です：

1. **物理キー入力からの検知の困難性**: ブラウザのKeyboardEventでは、QMK/VIAレベルでのMO(n)キーの状態を直接取得できない
2. **キーマップへの依存**: MO(n)キーの位置はユーザーのキーマップ設定に依存するため、汎用的な検知が難しい
3. **代替手段の提供**: 手動レイヤー切り替えで同等の機能を実現

---

## 9. テスト戦略

### 9.1 単体テスト
- キーコード変換処理
- ひらがな変換ロジック
- WPM、正確率計算
- 判定ロジック

### 9.2 統合テスト
- 日本語入力の全フロー
- 誤入力時の処理フロー
- レイヤー表示管理とキーハイライト

### 9.3 シナリオテスト
```
シナリオ1: 「きょう」の入力
  k → y → a → u
  期待：『きょう』と表示
  
シナリオ2: 「にほんご」の入力
  n → i → h → o → n → g → o
  期待：『にほんご』と表示（複雑なローマ字組み合わせ）

シナリオ3: 誤入力「あ」を期待している状態で「い」を入力
  期待：赤色ハイライト + 画面揺らし
```
