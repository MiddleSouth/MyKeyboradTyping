# MyKeyboardTyping - UIコンポーネント設計仕様書

## 1. 概要

このドキュメントではNuxt 3/Vue 3ベースのUIコンポーネント構成、画面レイアウト、インタラクション設計について定義します。

---

## 2. 画面構成

### 2.1 全体フロー図

```
┌─────────────────────────┐
│  キーボード選択画面      │
│  (KeyboardSelectView)   │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  タイピング練習画面                  │
│  (TypingPracticeView)              │
│  ┌──────────────────────────────┐  │
│  │ 練習テキスト表示              │  │
│  │ (PracticeTextDisplay)        │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │ キーボード表示 (SVG)          │  │
│  │ (KeyboardVisualization)      │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │ 統計情報パネル                │  │
│  │ (StatisticsPanel)            │  │
│  └──────────────────────────────┘  │
└────────┬────────────────────────────┘
         │ (練習完了)
         ▼
┌─────────────────────┐
│  結果画面            │
│  (ResultsView)      │
└─────────────────────┘
```

---

## 3. コンポーネント詳細設計

### 3.1 キーボード選択画面

**ファイル**: `components/KeyboardSelectView.vue`

#### 機能
- 接続されているRemap対応キーボードの一覧表示
- キーボードの選択
- エラーメッセージの表示（検出失敗時）

#### レイアウト
```
┌─────────────────────────────────┐
│  MyKeyboardTyping              │
│─────────────────────────────────│
│                                 │
│  キーボード選択                 │
│  ━━━━━━━━━━━━━━━━━━━━━━━  │
│                                 │
│  接続中のキーボード:             │
│  [ ] Ergo68 (USB ID: xxx)       │
│  [ ] [検出中...]               │
│                                 │
│                [キーボード確認]  │
│                                 │
│  ※Remap対応キーボードの接続が   │
│    必要です。                   │
└─────────────────────────────────┘
```

#### コンポーネント構造
```typescript
// KeyboardSelectView.vue
<template>
  <div class="keyboard-select-container">
    <h1>キーボード選択</h1>
    
    <div v-if="isLoading" class="loading">
      接続中のキーボードを検索中...
    </div>
    
    <div v-else-if="keyboards.length > 0" class="keyboard-list">
      <div
        v-for="keyboard in keyboards"
        :key="`${keyboard.vendorId}:${keyboard.productId}`"
        class="keyboard-item"
        @click="selectKeyboard(keyboard)"
      >
        <input type="radio" :checked="selectedKeyboard === keyboard" />
        <span>{{ keyboard.productName }} ({{ keyboard.vendorId }}:{{ keyboard.productId }})</span>
      </div>
    </div>
    
    <div v-else class="no-devices">
      キーボードが見つかりません。Remap対応キーボードを接続してください。
    </div>
    
    <div class="actions">
      <button
        @click="confirmSelection"
        :disabled="!selectedKeyboard"
        class="btn-primary"
      >
        次へ進む
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { KeyboardDevice } from '@/types/keyboard';
import { useKeyboardManager } from '@/composables/useKeyboardManager';

const { detectKeyboards, selectKeyboard: selectKeyboardManager } = useKeyboardManager();

const keyboards = ref<KeyboardDevice[]>([]);
const selectedKeyboard = ref<KeyboardDevice | null>(null);
const isLoading = ref(true);

onMounted(async () => {
  try {
    keyboards.value = await detectKeyboards();
  } catch (error) {
    console.error('Failed to detect keyboards:', error);
  } finally {
    isLoading.value = false;
  }
});

async function selectKeyboard(keyboard: KeyboardDevice) {
  selectedKeyboard.value = keyboard;
}

async function confirmSelection() {
  if (!selectedKeyboard.value) return;
  
  try {
    await selectKeyboardManager(selectedKeyboard.value);
    // TypingPracticeViewに遷移
    navigateTo('/practice');
  } catch (error) {
    console.error('Failed to select keyboard:', error);
  }
}
</script>

<style scoped>
.keyboard-select-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 2rem;
}

.keyboard-list {
  margin: 2rem 0;
}

.keyboard-item {
  padding: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin: 0.5rem 0;
  cursor: pointer;
  transition: background-color 0.2s;
}

.keyboard-item:hover {
  background-color: #f5f5f5;
}

.btn-primary {
  padding: 0.5rem 2rem;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
```

---

### 3.2 タイピング練習画面

**ファイル**: `components/TypingPracticeView.vue`

#### レイアウト

```
┌───────────────────────────────────────────────┐
│  MyKeyboardTyping - タイピング練習             │
│───────────────────────────────────────────────│
│                                               │
│  練習テキスト:                                 │
│  ┌─────────────────────────────────────────┐ │
│  │きょうはいいてんきですね。                 │ │
│  │▲ (カーソル位置)                          │ │
│  └─────────────────────────────────────────┘ │
│                                               │
│  ┌─────────────────────────────────────────┐ │
│  │          キーボード表示                  │ │
│  │     (SVGで描画、押下キーがハイライト)   │ │
│  │   レイヤー: 0                             │ │
│  └─────────────────────────────────────────┘ │
│                                               │
│  統計情報:                                     │
│  WPM: 120  正確率: 98.5%  ミス: 1  時間: 0:12 │
│                                               │
└───────────────────────────────────────────────┘
```

#### 3.2.1 子コンポーネント: PracticeTextDisplay

**ファイル**: `components/PracticeTextDisplay.vue`

```typescript
<template>
  <div class="practice-text-container">
    <h2>練習テキスト</h2>
    <div class="text-display">
      <!-- 入力済み部分 -->
      <span class="completed">{{ completedText }}</span>
      
      <!-- 現在の位置 -->
      <span class="current-char">{{ currentChar }}</span>
      
      <!-- 残り部分 -->
      <span class="remaining">{{ remainingText }}</span>
    </div>
    
    <!-- エラーハイライト -->
    <div v-if="lastError" class="error-feedback">
      期待: 「{{ lastError.expected }}」
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';

interface Props {
  targetText: string;
  currentIndex: number;
  lastError?: { expected: string; actual: string } | null;
}

const props = withDefaults(defineProps<Props>(), {
  lastError: null,
});

const completedText = computed(() => props.targetText.substring(0, props.currentIndex));
const currentChar = computed(() => props.targetText[props.currentIndex] || '');
const remainingText = computed(() => props.targetText.substring(props.currentIndex + 1));
</script>

<style scoped>
.practice-text-container {
  padding: 1.5rem;
  background-color: #f9f9f9;
  border-radius: 8px;
  margin-bottom: 2rem;
}

.text-display {
  font-size: 1.5rem;
  line-height: 1.8;
  font-family: 'Hiragino Maru Gothic', sans-serif;
  margin: 1rem 0;
}

.completed {
  color: #4caf50;
  background-color: #e8f5e9;
}

.current-char {
  background-color: #ffeb3b;
  animation: blink 1s infinite;
  padding: 2px 4px;
}

.remaining {
  color: #999;
}

.error-feedback {
  color: #d32f2f;
  font-weight: bold;
  margin-top: 0.5rem;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0.3; }
}
</style>
```

#### 3.2.2 子コンポーネント: KeyboardVisualization

**ファイル**: `components/KeyboardVisualization.vue`

```typescript
<template>
  <div class="keyboard-visualization">
    <h2>キーボード</h2>
    <div class="layer-indicator">レイヤー: {{ currentLayer }}</div>
    
    <svg :viewBox="`0 0 ${width} ${height}`" class="keyboard-svg">
      <!-- キーをグループ化して描画 -->
      <g
        v-for="key in visibleKeys"
        :key="`${key.row}-${key.col}`"
        :class="getKeyClass(key)"
        @mouseenter="highlightedKey = key"
        @mouseleave="highlightedKey = null"
      >
        <!-- キーの背景 -->
        <rect
          :x="key.x"
          :y="key.y"
          :width="keyWidth"
          :height="keyHeight"
          :fill="getKeyFill(key)"
          :stroke="getKeyStroke(key)"
          stroke-width="2"
          rx="4"
        />
        
        <!-- キーラベル -->
        <text
          :x="key.x + keyWidth / 2"
          :y="key.y + keyHeight / 2"
          text-anchor="middle"
          dominant-baseline="middle"
          :font-size="labelFontSize"
          :fill="getKeyTextColor(key)"
        >
          {{ key.label }}
        </text>
      </g>
    </svg>
  </div>
</template>

<script setup lang="ts">
import { computed, ref } from 'vue';
import { KeyPosition } from '@/types/keyboard';

interface Props {
  keymapData: KeymapData;
  currentLayer: number;
  pressedKeys: Set<number>; // 押下中のHIDキーコード
  errorKey?: number | null;
}

const props = withDefaults(defineProps<Props>(), {
  errorKey: null,
});

const width = 1200;
const height = 400;
const keyWidth = 60;
const keyHeight = 60;
const labelFontSize = 14;

const highlightedKey = ref<KeyPosition | null>(null);

// 現在のレイヤーの可視キーを取得
const visibleKeys = computed(() => {
  return generateKeyPositions(props.keymapData, props.currentLayer);
});

function getKeyClass(key: KeyPosition): string {
  const classes: string[] = [];
  if (props.pressedKeys.has(key.hidCode)) {
    classes.push('pressed');
  }
  if (props.errorKey === key.hidCode) {
    classes.push('error');
  }
  if (highlightedKey.value === key) {
    classes.push('hover');
  }
  return classes.join(' ');
}

function getKeyFill(key: KeyPosition): string {
  if (props.errorKey === key.hidCode) {
    return '#ff6b6b'; // 赤色
  }
  if (props.pressedKeys.has(key.hidCode)) {
    return '#4caf50'; // 緑色
  }
  if (highlightedKey.value === key) {
    return '#e0e0e0';
  }
  return '#ffffff';
}

function getKeyStroke(key: KeyPosition): string {
  return '#999';
}

function getKeyTextColor(key: KeyPosition): string {
  if (props.errorKey === key.hidCode || props.pressedKeys.has(key.hidCode)) {
    return '#ffffff';
  }
  return '#333';
}

function generateKeyPositions(keymap: KeymapData, layer: number): KeyPosition[] {
  // Ergo68のキーレイアウト定義に基づいてキー位置を生成
  // 詳細は別モジュール
  return [];
}
</script>

<style scoped>
.keyboard-visualization {
  padding: 1.5rem;
  background-color: #f5f5f5;
  border-radius: 8px;
  margin-bottom: 2rem;
}

.layer-indicator {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 1rem;
}

.keyboard-svg {
  width: 100%;
  max-width: 1000px;
  border: 1px solid #ddd;
  background-color: white;
  border-radius: 4px;
}

g.pressed rect {
  filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.8));
}

g.error rect {
  filter: drop-shadow(0 0 8px rgba(255, 107, 107, 0.8));
}

g.hover rect {
  filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.2));
}
</style>
```

#### 3.2.3 子コンポーネント: StatisticsPanel

**ファイル**: `components/StatisticsPanel.vue`

```typescript
<template>
  <div class="statistics-panel">
    <h2>統計情報</h2>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">WPM</div>
        <div class="stat-value">{{ statistics.wpm }}</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">正確率</div>
        <div class="stat-value">{{ statistics.accuracy }}%</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">ミス数</div>
        <div class="stat-value">{{ statistics.errorCount }}</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">経過時間</div>
        <div class="stat-value">{{ statistics.elapsedTime }}</div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
interface Statistics {
  wpm: number;
  accuracy: number;
  errorCount: number;
  elapsedTime: string;
}

interface Props {
  statistics: Statistics;
}

withDefaults(defineProps<Props>(), {});
</script>

<style scoped>
.statistics-panel {
  padding: 1.5rem;
  background-color: #f0f4ff;
  border-radius: 8px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-top: 1rem;
}

.stat-item {
  background-color: white;
  padding: 1rem;
  border-radius: 4px;
  text-align: center;
  border-left: 4px solid #2196f3;
}

.stat-label {
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.8rem;
  font-weight: bold;
  color: #2196f3;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
```

---

### 3.3 結果画面

**ファイル**: `components/ResultsView.vue`

#### レイアウト

```
┌─────────────────────────────────┐
│  練習完了！                      │
│─────────────────────────────────│
│                                 │
│  最終結果                       │
│  ━━━━━━━━━━━━━━━━━━━━━━  │
│                                 │
│  WPM: 125                       │
│  正確率: 97.2%                  │
│  ミス数: 3                      │
│  経過時間: 1:45                 │
│                                 │
│           [もう一度] [別の素材]  │
│                                 │
└─────────────────────────────────┘
```

#### コンポーネント構造

```typescript
<template>
  <div class="results-container">
    <h1>練習完了！</h1>
    
    <div class="results-summary">
      <h2>最終結果</h2>
      <div class="results-grid">
        <div class="result-item">
          <div class="label">WPM</div>
          <div class="value">{{ finalResults.wpm }}</div>
        </div>
        <div class="result-item">
          <div class="label">正確率</div>
          <div class="value">{{ finalResults.accuracy }}%</div>
        </div>
        <div class="result-item">
          <div class="label">ミス数</div>
          <div class="value">{{ finalResults.errorCount }}</div>
        </div>
        <div class="result-item">
          <div class="label">経過時間</div>
          <div class="value">{{ finalResults.elapsedTime }}</div>
        </div>
      </div>
    </div>
    
    <div class="actions">
      <button @click="retryPractice" class="btn btn-primary">
        もう一度
      </button>
      <button @click="changeContent" class="btn btn-secondary">
        別の素材
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
const emit = defineEmits<{
  retry: [];
  changeContent: [];
}>();

interface Props {
  finalResults: {
    wpm: number;
    accuracy: number;
    errorCount: number;
    elapsedTime: string;
  };
}

withDefaults(defineProps<Props>(), {});

function retryPractice() {
  emit('retry');
}

function changeContent() {
  emit('changeContent');
}
</script>

<style scoped>
.results-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 2rem;
  margin: 2rem 0;
}

.result-item {
  padding: 1.5rem;
  background-color: #f5f5f5;
  border-radius: 8px;
}

.label {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 0.5rem;
}

.value {
  font-size: 2rem;
  font-weight: bold;
  color: #2196f3;
}

.actions {
  margin-top: 2rem;
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.btn {
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
}

.btn-primary {
  background-color: #2196f3;
  color: white;
}

.btn-secondary {
  background-color: #f0f0f0;
  color: #333;
}
</style>
```

---

## 4. スタイル・テーマ

### 4.1 Tailwind CSS設定

```typescript
// tailwind.config.ts
module.exports = {
  theme: {
    colors: {
      primary: '#2196f3',
      success: '#4caf50',
      error: '#ff6b6b',
      warning: '#ff9800',
      light: '#f5f5f5',
      dark: '#333',
    },
  },
};
```

### 4.2 アニメーション

```css
/* キーハイライトアニメーション */
@keyframes keyPress {
  0% { transform: scale(1); }
  50% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

/* エラーフィードバック */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* 誤入力時の点滅 */
@keyframes errorFlash {
  0%, 100% { background-color: transparent; }
  50% { background-color: #ffebee; }
}
```

---

## 5. レスポンシブ対応

PCでの利用のみ想定のため不要（1024px想定で開発）

---

## 6. アクセシビリティ

- キーボード操作のみで完結
- ARIA ラベルの適切な設定

---

## 7. 開発チェックリスト

- [ ] KeyboardSelectView 実装
- [ ] TypingPracticeView 実装
- [ ] PracticeTextDisplay コンポーネント実装
- [ ] KeyboardVisualization コンポーネント実装
- [ ] StatisticsPanel コンポーネント実装
- [ ] ResultsView 実装
- [ ] Tailwind CSS スタイリング
- [ ] アニメーション実装
- [ ] アクセシビリティテスト
