# MyKeyboardTyping - データ構造定義仕様書

## 1. 概要

このドキュメントではTypeScriptで定義するインターフェース、型定義、データモデルについて記載します。

---

## 2. キーボード関連の型定義

### 2.1 基本的なキーボード情報

```typescript
// types/keyboard.ts

/**
 * USB HIDデバイス情報
 */
export interface HIDDevice {
  vendorId: number;
  productId: number;
  productName: string;
  opened: boolean;
}

/**
 * キーボードデバイスの情報
 */
export interface KeyboardDevice {
  vendorId: number;
  productId: number;
  productName: string;
  deviceHandle: HIDDevice;
  isConnected: boolean;
  layerCount: number;
  supportedFeatures: string[];
}

/**
 * キーボード定義（マッピング情報）
 */
export interface KeyboardDefinition {
  id: string;
  name: string;
  vendorId: number;
  productId: number;
  width: number;
  height: number;
  layouts: KeyboardLayout[];
  matrix: KeyMatrix;
}

/**
 * キーボードレイアウト
 */
export interface KeyboardLayout {
  name: string;
  layers: number;
  keys: KeyPosition[];
}
```

### 2.2 キー配置・座標情報

```typescript
/**
 * キーの物理的位置情報
 */
export interface KeyPosition {
  row: number;               // 行番号（0から始まる）
  col: number;               // 列番号（0から始まる）
  x: number;                 // SVG描画時のX座標
  y: number;                 // SVG描画時のY座標
  width: number;             // キーの幅（相対値）
  height: number;            // キーの高さ（相対値）
  label: string;             // 表示ラベル（例："A", "Shift"）
  hidCode: number;           // HIDキーコード
  isModifier: boolean;       // 修飾キーフラグ
}

/**
 * キーマトリックス（物理配置とHIDの対応）
 */
export interface KeyMatrix {
  rows: number;
  cols: number;
  layout: number[][];        // [row][col] = HIDコード
}
```

### 2.3 キーマップデータ

```typescript
/**
 * キーコード情報（単一のキー）
 */
export interface KeyCodeInfo {
  code: string;              // HIDコード（"0x04" など）
  label: string;             // 表示ラベル（"A", "1", "Shift" など）
  baseChar?: string;         // 修飾なし時の文字
  shiftChar?: string;        // Shift押下時の文字
  isModifier: boolean;       // 修飾キーか
  keyType: KeyType;          // キーのタイプ
}

export type KeyType = 'alphanumeric' | 'modifier' | 'function' | 'navigation';

/**
 * レイヤー情報（1つのレイヤーのキーマップ）
 */
export interface Layer {
  layerNumber: number;       // 0～3
  keymap: KeyCode[][];       // [row][col] = キーコード
  encoders?: EncoderMapping[]; // ロータリーエンコーダ（オプション）
}

/**
 * キーマップ全体
 */
export interface KeymapData {
  layers: Layer[];
  keyboardId: string;
  lastUpdated: number;       // タイムスタンプ
}

/**
 * 個別のキーコード（キーマップ内で使用）
 */
export interface KeyCode {
  hidCode: number;
  label: string;
}

/**
 * ロータリーエンコーダマッピング
 */
export interface EncoderMapping {
  id: number;
  cw: KeyCode;               // 時計回り
  ccw: KeyCode;              // 反時計回り
}
```

---

## 3. 入力・タイピング関連の型定義

### 3.1 入力イベント

```typescript
// types/input.ts

/**
 * WebHID レポート情報
 */
export interface HIDReport {
  modifierByte: number;      // ビットフラグ（Shift, Ctrl等）
  keyCodes: number[];        // HIDキーコード配列
  timestamp: number;         // イベント時刻
}

/**
 * キー入力イベント
 */
export interface KeyInputEvent {
  type: 'keydown' | 'keyup';
  keyCode: number;           // HIDキーコード
  modifiers: Modifiers;      // 修飾キーの状態
  timestamp: number;
}

/**
 * 修飾キーの状態
 */
export interface Modifiers {
  ctrl: boolean;
  shift: boolean;
  alt: boolean;
  win: boolean;
}
```

### 3.2 タイピング練習の状態

```typescript
// types/typing.ts

/**
 * タイピング練習の状態
 */
export interface TypingState {
  targetText: string;        // 目標テキスト（練習素材）
  inputText: string;         // ユーザー入力テキスト
  currentIndex: number;      // 現在の入力位置
  startTime: number;         // 練習開始時刻
  isCompleted: boolean;      // 完了フラグ
  errors: ErrorRecord[];     // 誤入力履歴
  layerState: LayerState;    // レイヤー状態
}

/**
 * 誤入力レコード
 */
export interface ErrorRecord {
  index: number;             // テキスト内の位置
  expected: string;          // 期待される文字
  actual: string;            // 実際に入力された文字
  timestamp: number;         // 誤入力時刻
}

/**
 * レイヤー状態
 */
export interface LayerState {
  activeLayer: number;       // 現在のアクティブレイヤー（0～3）
  modifierKeys: Set<number>; // 押下中の修飾キー
}

/**
 * 判定結果
 */
export interface JudgmentResult {
  status: 'success' | 'error' | 'pending' | 'skip' | 'complete';
  feedback?: string;         // フィードバック内容
  expected?: string;         // 期待される文字（エラー時）
  actual?: string;           // 実際に入力された文字（エラー時）
}

/**
 * ローマ字変換結果
 */
export interface ConversionResult {
  kana?: string;             // 変換されたひらがな
  pending?: boolean;         // 確定待ち（次の入力待機中）
  error?: boolean;           // エラー
  remaining?: string;        // 残りのバッファ
}
```

### 3.3 統計情報

```typescript
// types/statistics.ts

/**
 * リアルタイム統計情報
 */
export interface Statistics {
  wpm: number;               // Words Per Minute
  accuracy: number;          // 正確率（0～100）
  errorCount: number;        // 誤入力数
  elapsedTime: string;       // 経過時間（"M:SS"形式）
  charCount: number;         // 入力文字数
}

/**
 * 最終結果
 */
export interface FinalResult extends Statistics {
  completedAt: number;       // 完了時刻
  practiceContentId: string; // 練習素材ID
  keyboardId: string;        // キーボードID
}
```

---

## 4. 練習素材関連の型定義

### 4.1 練習素材

```typescript
// types/content.ts

/**
 * 練習素材（1つのテキスト）
 */
export interface PracticeContent {
  id: string;
  title: string;
  text: string;              // 練習対象テキスト
  language: 'ja' | 'en';     // 言語
  difficulty: 'easy' | 'medium' | 'hard';
  category: string;          // カテゴリ（例："基本", "文章" など）
  estimatedTime: number;     // 推定完了時間（秒）
  createdAt: number;         // 作成日時
}

/**
 * 練習素材グループ（同じカテゴリの複数素材）
 */
export interface PracticeContentGroup {
  id: string;
  name: string;
  contents: PracticeContent[];
  description?: string;
}
```

### 4.2 日本語処理関連

```typescript
// types/japanese.ts

/**
 * ひらがな変換テーブルのエントリ
 */
export interface RomajiEntry {
  romaji: string;            // ローマ字（例："ka"）
  hiragana: string;          // ひらがな（例："か"）
  variations?: string[];     // 異なるローマ字表記（例：["ca"] → "か"）
}

/**
 * 複数パターンのひらがな
 */
export interface MultiPatternKana {
  hiragana: string;
  romajiPatterns: string[];  // 複数の入力パターン
}

/**
 * ひらがナ変換マップ
 */
export type RomajiMap = Map<string, string>;
export type MultiPatternMap = Map<string, string[]>;
```

---

## 5. HID キーコード定義

### 5.1 キーコードマッピング定義

```typescript
// types/hidKeyCodes.ts

/**
 * HID キーコード定義（標準USB HID仕様）
 * 出典：https://www.usb.org/sites/default/files/documents/hid1_11.pdf
 */
export const HIDKeyCodes = {
  // アルファベット
  'A': 0x04,
  'B': 0x05,
  'C': 0x06,
  'D': 0x07,
  'E': 0x08,
  'F': 0x09,
  'G': 0x0A,
  'H': 0x0B,
  'I': 0x0C,
  'J': 0x0D,
  'K': 0x0E,
  'L': 0x0F,
  'M': 0x10,
  'N': 0x11,
  'O': 0x12,
  'P': 0x13,
  'Q': 0x14,
  'R': 0x15,
  'S': 0x16,
  'T': 0x17,
  'U': 0x18,
  'V': 0x19,
  'W': 0x1A,
  'X': 0x1B,
  'Y': 0x1C,
  'Z': 0x1D,

  // 数字
  '1': 0x1E,
  '2': 0x1F,
  '3': 0x20,
  '4': 0x21,
  '5': 0x22,
  '6': 0x23,
  '7': 0x24,
  '8': 0x25,
  '9': 0x26,
  '0': 0x27,

  // 修飾キー
  'LeftCtrl': 0xE0,
  'LeftShift': 0xE1,
  'LeftAlt': 0xE2,
  'LeftWin': 0xE3,
  'RightCtrl': 0xE4,
  'RightShift': 0xE5,
  'RightAlt': 0xE6,
  'RightWin': 0xE7,

  // 機能キー
  'Enter': 0x28,
  'Escape': 0x29,
  'Backspace': 0x2A,
  'Tab': 0x2B,
  'Space': 0x2C,

  // その他
  'CapsLock': 0x39,
  'Delete': 0x4C,
  'Up': 0x52,
  'Down': 0x51,
  'Left': 0x50,
  'Right': 0x4F,
} as const;

export type HIDKeyCode = keyof typeof HIDKeyCodes;
```

### 5.2 キーコード逆変換マップ

```typescript
// 数値キーコード → ラベルの逆マップ
export const HIDKeyCodeToLabel: Map<number, string> = new Map(
  Object.entries(HIDKeyCodes).map(([label, code]) => [code, label])
);
```

---

## 6. Ergo68 固有定義

### 6.1 Ergo68 キーマトリックス

```typescript
// types/ergo68.ts

/**
 * Ergo68 のキーマトリックス定義
 * 68キー = 左34キー + 右34キー
 */
export const ERGO68_MATRIX = {
  rows: 5,    // 5行
  cols: 7,    // 左右各7列
  layout: [
    // レイヤー0（デフォルト）
    [
      [0x35, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23],  // 行0
      [0x2B, 0x14, 0x1A, 0x08, 0x15, 0x17, null],  // 行1
      [0x39, 0x04, 0x16, 0x07, 0x09, 0x0A, null],  // 行2
      [0xE1, 0x1D, 0x18, 0x06, 0x19, 0x05, null],  // 行3
      [0xE0, 0xE3, 0xE2, 0xF1, 0x2C, 0xF0, null],  // 行4
    ],
    // ... その他のレイヤーはキーボードから取得
  ],
};

/**
 * Ergo68 キーボード定義
 */
export const ERGO68_DEFINITION: KeyboardDefinition = {
  id: 'ergo68',
  name: 'Ergo68',
  vendorId: 0x04D8,
  productId: 0xEB3D,
  width: 1200,
  height: 400,
  layouts: [
    {
      name: 'Default',
      layers: 4,
      keys: generateErgo68KeyPositions(),
    },
  ],
  matrix: ERGO68_MATRIX,
};

/**
 * Ergo68 のキー配置を生成
 */
function generateErgo68KeyPositions(): KeyPosition[] {
  // SVG上の座標を計算してキー位置を生成
  const keys: KeyPosition[] = [];
  const baseX = 30;
  const baseY = 30;
  const keySize = 60;
  const spacing = 5;

  // 左側
  let x = baseX;
  let y = baseY;
  
  // ... キー配置ロジック

  return keys;
}
```

---

## 7. エラー・例外型

```typescript
// types/errors.ts

/**
 * カスタムエラー
 */
export class KeyboardError extends Error {
  constructor(public code: string, message: string) {
    super(message);
    this.name = 'KeyboardError';
  }
}

export class KeymapError extends Error {
  constructor(public code: string, message: string) {
    super(message);
    this.name = 'KeymapError';
  }
}

export class ConversionError extends Error {
  constructor(public code: string, message: string) {
    super(message);
    this.name = 'ConversionError';
  }
}
```

---

## 8. 設定・ユーザープリファレンス

```typescript
// types/settings.ts

/**
 * ユーザー設定
 */
export interface UserSettings {
  soundEnabled: boolean;          // エラー音
  vibrationEnabled: boolean;      // 振動フィードバック
  theme: 'light' | 'dark';        // テーマ
  fontSize: number;               // フォントサイズ
  keyboardHighlightDuration: number; // キーハイライト表示時間（ms）
  language: 'ja' | 'en';
}

/**
 * デフォルト設定
 */
export const DEFAULT_SETTINGS: UserSettings = {
  soundEnabled: true,
  vibrationEnabled: true,
  theme: 'light',
  fontSize: 16,
  keyboardHighlightDuration: 300,
  language: 'ja',
};
```

---

## 9. API レスポンス型

```typescript
// types/api.ts

/**
 * Remap API レスポンス（キーマップ取得）
 */
export interface RemapAPIKeymap {
  keyboard: {
    id: string;
    name: string;
  };
  layers: {
    [layerNumber: number]: number[][]; // [row][col] = キーコード
  };
}

/**
 * 一般的なAPIレスポンスラッパー
 */
export interface APIResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}
```

---

## 10. 総合的なコンテキスト型

```typescript
// types/context.ts

/**
 * アプリケーション全体の状態
 */
export interface AppContext {
  selectedKeyboard: KeyboardDevice | null;
  keymapData: KeymapData | null;
  typingState: TypingState | null;
  currentSettings: UserSettings;
  practiceContents: PracticeContent[];
  selectedContent: PracticeContent | null;
}

/**
 * ページの状態
 */
export type PageState = 'select-keyboard' | 'select-content' | 'typing' | 'results';
```

---

## 11 実装チェックリスト

- [ ] すべての型定義をファイルに落とし込む
- [ ] HIDキーコードテーブルを完成させる
- [ ] Ergo68の座標計算ロジック完成
- [ ] Vuex/Piniaストア実装時に型定義を利用
- [ ] コンポーネント内で型定義を活用
- [ ] 型チェック：`tsc --noEmit`で確認
